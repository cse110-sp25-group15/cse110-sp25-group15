import{s as i}from"./bottom-nav.js";import m from"https://cdn.skypack.dev/heic2any";import g from"https://cdn.skypack.dev/browser-image-compression";const u=Object.freeze({SPORTS:"Sports",BOOKS:"Books",SUPPLIES:"Supplies",TECH:"Tech",TRANSPORTATION:"Transportation",APPAREL:"Apparel",DORM_LIFE:"Dorm Life",FURNITURE:"Furniture",OTHER:"Other"});class h{constructor(){this.listings=[]}async fetchAllListings(){try{const{data:e,error:t}=await i.from("listings").select();if(t)throw console.error("Error fetching listings:",t),t;return this.listings=e,this.listings}catch(e){throw console.error("Failed to fetch listings:",e),e}}async fetchListingsByCategory(e){if(!Object.values(u).includes(e))throw new Error(`Invalid category: ${e}`);try{const{data:t,error:r}=await i.from("listings").select().eq("category",e);if(r)throw console.error(`Error fetching ${e} listings:`,r),r;return t}catch(t){throw console.error(`Failed to fetch ${e} listings:`,t),t}}async fetchAllListingsSortByDate(e=!1){try{const{data:t,error:r}=await i.from("listings").select().order("date_posted",{ascending:e});if(r)throw console.error("Error fetching listings:",r),r;return t}catch(t){throw console.error("Failed to fetch listings:",t),t}}async fetchAllListingsSortByPrice(e){try{const{data:t,error:r}=await i.from("listings").select().order("price",{ascending:e});if(r)throw console.error("Error fetching listings by price:",r),r;return t}catch(t){throw console.error("Failed to fetch listings by price:",t),t}}async getListingById(e){const t=this.listings.find(r=>r.listing_id===e);if(t)return t;try{const{data:r,error:o}=await i.from("listings").select().eq("listing_id",e).single();return o?(console.error(`Error fetching listing ${e}:`,o),null):r}catch(r){return console.error(`Failed to fetch listing ${e}:`,r),null}}async fetchListingsByUser(e){try{const{data:t,error:r}=await i.from("listings").select("*").eq("user_id",e);if(r)throw console.error("Error fetching user listings:",r),r;return t}catch(t){throw console.error("Failed to fetch user listings:",t),t}}async deleteListingById(e){try{const{error:t}=await i.from("images").delete().eq("listing_id",e);t&&console.warn("Warning: failed to delete images for listing:",t);const{error:r}=await i.from("listings").delete().eq("listing_id",e);if(r)throw console.error("Error deleting listing:",r),r;console.log(`Listing ${e} deleted successfully.`)}catch(t){throw console.error("Failed to delete listing:",t),t}}formatListingForView(e){return{listing_id:e.listing_id,title:e.title,price:e.price,image_url:e.thumbnail||"https://via.placeholder.com/300x400",date_posted:e.date_posted}}async searchListings(e){if(!e||typeof e!="string")throw new Error("Query must be a non-empty string");try{const{data:t,error:r}=await i.from("listings").select().or(`title.ilike.%${e}%,description.ilike.%${e}%`);if(r)throw console.error("Error searching listings:",r),r;return t}catch(t){throw console.error("Failed to search listings:",t),t}}}class p{constructor(){this.model=new h,this.browsePage=document.querySelector("browse-page"),this.productsContainer=null,this.overlay=document.getElementById("product-detail-overlay"),this.categoryButtons=[],this.currentCategory=null}init(){if(!this.browsePage||!this.browsePage.shadowRoot){console.error("Browse page or shadow root not found");return}if(this.productsContainer=this.browsePage.shadowRoot.querySelector(".products-container"),!this.productsContainer){console.error("Products container not found");return}this.browsePage&&this.browsePage.shadowRoot?(this.categoryButtons=Array.from(this.browsePage.shadowRoot.querySelectorAll("category-button")),console.log("Found category buttons:",this.categoryButtons.length),this.categoryButtons.length>0):console.error("Cannot find category buttons: browse-page or its shadow root is missing"),this.loadListings(),document.addEventListener("card-click",e=>{console.log("Card clicked event received"),console.log(e.detail);const t=e.detail.listingId;this.showProductDetail(t)}),document.addEventListener("filter-changed",e=>{console.log("Filter changed event received:",e.detail);const t=e.detail.category;this.setSelectedCategory(t)})}setSelectedCategory(e){this.currentCategory=e,this.categoryButtons.forEach(t=>{t.shadowRoot.querySelector("slot").assignedNodes().map(l=>l.textContent).join("").trim()===e?t.setAttribute("selected",""):t.removeAttribute("selected")}),console.log("Category selected:",e),this.filterListingsByCategory(e)}async filterListingsByCategory(e){try{if(!this.productsContainer){console.error("Products container not found");return}this.productsContainer.innerHTML="";const t=await this.model.fetchAllListings(),r=e==="All"?t:t.filter(o=>o.category===e);r.forEach(o=>{this.renderListingCard(o)}),console.log(`Filtered listings by "${e}" category:`,r.length)}catch(t){console.error("Failed to filter listings:",t)}}async loadListings(){try{if(!this.productsContainer){console.error("Products container not found");return}this.productsContainer.innerHTML="";const e=await this.model.fetchAllListings();if(!this.productsContainer){console.error("Products container no longer available");return}e.forEach(t=>{this.renderListingCard(t)}),console.log("Loaded listings:",e)}catch(e){console.error("Controller failed to load listings:",e)}}renderListingCard(e){if(!this.productsContainer){console.error("Cannot render card, products container not available");return}const t=this.model.formatListingForView(e),r=document.createElement("product-card");r.setAttribute("listing-id",t.listing_id||""),r.setAttribute("title",t.title||""),r.setAttribute("price",t.price||""),r.setAttribute("image-url",t.image_url||""),r.setAttribute("date",t.date_posted||""),r.classList.add("card"),this.productsContainer.appendChild(r)}async showProductDetail(e){console.log("Showing product detail for listing ID:",e);try{const t=await this.model.getListingById(e);if(!t){console.error(`Listing with ID ${e} not found`);return}if(!this.overlay){console.error("Product overlay component not found");return}this.overlay.setAttribute("name",t.title||""),this.overlay.setAttribute("price",t.price||""),this.overlay.setAttribute("condition",t.condition||""),this.overlay.setAttribute("date",t.date_posted||""),this.overlay.setAttribute("description",t.description||""),this.overlay.setAttribute("images",t.thumbnail||""),this.overlay.show()}catch(t){console.error("Error showing product detail:",t)}}notifyError(e){alert(e)}notifySuccess(e){alert(e)}async searchListings(e){return await this.model.searchListings(e)}async renderSearchResults(e){if(!this.productsContainer){console.error("Products container not found");return}this.productsContainer.innerHTML="";try{const t=await this.searchListings(e);if(!t||t.length===0){this.productsContainer.innerHTML='<div class="no-results">No results found.</div>';return}t.forEach(r=>{this.renderListingCard(r)}),console.log(`Rendered ${t.length} search results for query: "${e}"`)}catch(t){this.productsContainer.innerHTML='<div class="no-results">Error searching listings.</div>',console.error("Error rendering search results:",t)}}}const w={NEW:"New",LIKE_NEW:"Like New",LIGHTLY_USED:"Lightly Used",USED:"Used"};class b{constructor(){this.model=new h}init(){document.addEventListener("listing-submit",this.handleListingSubmit.bind(this))}_generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}async convertImageToWebP(e){if(!e)throw new Error("No file provided");const t=e.type;let r;try{if(t==="image/heic"||e.name.endsWith(".HEIC")){r=await m({blob:e,toType:"image/webp",quality:.8});const o=new File([r],e.name.replace(/\.\w+$/,".webp"),{type:"image/webp"});r=await g(o,{maxSizeMB:.1,maxWidthOrHeight:800,fileType:"image/webp",useWebWorker:!0})}else r=await g(e,{maxSizeMB:.1,maxWidthOrHeight:800,fileType:"image/webp",useWebWorker:!0});return r}catch(o){throw console.error("Conversion failed:",o),o}}async _uploadFile(e,t,r){const o=`${t}/${r}/${e.name}`,{data:l,error:n}=await i.storage.from("listimages").upload(o,e,{upsert:!1});if(n)throw console.error("Error uploading file:",n),n;const{data:s}=i.storage.from("listimages").getPublicUrl(o);if(console.log("Public URL:",s.publicUrl),s.error)throw console.error("Error getting public URL:",s.error),s.error;return s.publicUrl}async handleListingSubmit(e){console.log("Listing submit event received");const t=e.detail;if(console.log("Listing data:",t),!Object.values(u).includes(t.category)){this.notifyError("Invalid category selected.");return}if(!Object.values(w).includes(t.condition)){this.notifyError("Invalid condition selected.");return}try{const{data:{user:r},error:o}=await i.auth.getUser();if(!r){this.notifyError("You must be signed in to create a listing");return}const l=this._generateUUID();let n=null;if(t.files&&t.files.length>0)try{const c=await this.convertImageToWebP(t.files[0]),f=t.files[0].name.replace(/\.\w+$/,".webp"),y=new File([c],f,{type:"image/webp"});n=await this._uploadFile(y,r.id,l),delete t.files}catch(c){console.error("File upload error:",c),this.notifyError("File upload failed.");return}const s={...t,listing_id:l,user_id:r.id,thumbnail:n},{data:L,error:d}=await i.from("listings").insert([s]).select();if(d){this.notifyError(d.message||"Failed to create listing");return}this.notifySuccess("Listing created successfully"),e.target&&typeof e.target.resetForm=="function"&&e.target.resetForm()}catch(r){console.error("Error handling listing submission:",r),this.notifyError("An unexpected error occurred")}}notifyError(e){alert(e)}notifySuccess(e){alert(e)}}document.addEventListener("DOMContentLoaded",async()=>{const a=new p;a.init(),new b().init();const t=document.querySelector(".logo");t&&t.addEventListener("click",()=>{window.location.href="/cse110-sp25-group15/"});const r=document.querySelector("hero-banner"),o=()=>{if(!r)return;r.getBoundingClientRect().bottom<=0&&r.remove()};window.addEventListener("scroll",o);const l=document.querySelector("search-box");l&&l.addEventListener("search-submit",async n=>{const s=n.detail.query;s&&await a.renderSearchResults(s)})});
