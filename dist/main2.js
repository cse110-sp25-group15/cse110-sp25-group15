import{s as o}from"./bottom-nav.js";import E from"https://cdn.skypack.dev/heic2any";import m from"https://cdn.skypack.dev/browser-image-compression";const p=Object.freeze({SPORTS:"Sports",BOOKS:"Books",SUPPLIES:"Supplies",TECH:"Tech",TRANSPORTATION:"Transportation",APPAREL:"Apparel",DORM_LIFE:"Dorm Life",FURNITURE:"Furniture",OTHER:"Other"});class y{constructor(){this.listings=[]}async fetchAllListings(){try{const{data:t,error:e}=await o.from("listings").select();if(e)throw console.error("Error fetching listings:",e),e;return this.listings=t,this.listings}catch(t){throw console.error("Failed to fetch listings:",t),t}}async fetchListingsByCategory(t){if(!Object.values(p).includes(t))throw new Error(`Invalid category: ${t}`);try{const{data:e,error:r}=await o.from("listings").select().eq("category",t);if(r)throw console.error(`Error fetching ${t} listings:`,r),r;return e}catch(e){throw console.error(`Failed to fetch ${t} listings:`,e),e}}async fetchAllListingsSortByDate(t=!1){try{const{data:e,error:r}=await o.from("listings").select().order("date_posted",{ascending:t});if(r)throw console.error("Error fetching listings:",r),r;return e}catch(e){throw console.error("Failed to fetch listings:",e),e}}async fetchAllListingsSortByPrice(t){try{const{data:e,error:r}=await o.from("listings").select().order("price",{ascending:t});if(r)throw console.error("Error fetching listings by price:",r),r;return e}catch(e){throw console.error("Failed to fetch listings by price:",e),e}}async getListingById(t){const e=this.listings.find(r=>r.listing_id===t);if(e)return e;try{const{data:r,error:i}=await o.from("listings").select().eq("listing_id",t).single();return i?(console.error(`Error fetching listing ${t}:`,i),null):r}catch(r){return console.error(`Failed to fetch listing ${t}:`,r),null}}async fetchListingsByUser(t){try{const{data:e,error:r}=await o.from("listings").select("*").eq("user_id",t);if(r)throw console.error("Error fetching user listings:",r),r;return e}catch(e){throw console.error("Failed to fetch user listings:",e),e}}async deleteListingById(t){try{const{error:e}=await o.from("images").delete().eq("listing_id",t);e&&console.warn("Warning: failed to delete images for listing:",e);const{error:r}=await o.from("listings").delete().eq("listing_id",t);if(r)throw console.error("Error deleting listing:",r),r;console.log(`Listing ${t} deleted successfully.`)}catch(e){throw console.error("Failed to delete listing:",e),e}}formatListingForView(t){return{listing_id:t.listing_id,title:t.title,price:t.price,image_url:t.thumbnail||"https://via.placeholder.com/300x400",date_posted:t.date_posted}}async searchListings(t){if(!t||typeof t!="string")throw new Error("Query must be a non-empty string");try{const{data:e,error:r}=await o.from("listings").select().or(`title.ilike.%${t}%,description.ilike.%${t}%`);if(r)throw console.error("Error searching listings:",r),r;return e}catch(e){throw console.error("Failed to search listings:",e),e}}}class v{constructor(){this.model=new y,this.browsePage=document.querySelector("browse-page"),this.productsContainer=null,this.overlay=document.getElementById("product-detail-overlay"),this.categoryButtons=[],this.currentCategory="All",this.currentSort=null}init(){if(!this.browsePage||!this.browsePage.shadowRoot){console.error("Browse page or shadow root not found");return}if(this.productsContainer=this.browsePage.shadowRoot.querySelector(".products-container"),!this.productsContainer){console.error("Products container not found");return}this.browsePage&&this.browsePage.shadowRoot?(this.categoryButtons=Array.from(this.browsePage.shadowRoot.querySelectorAll("category-button")),console.log("Found category buttons:",this.categoryButtons.length)):console.error("Cannot find category buttons: browse-page or its shadow root is missing"),this.fetchListings(),document.addEventListener("card-click",t=>{console.log("Card clicked event received");const e=t.detail.listingId;this.showProductDetail(e)}),document.addEventListener("filter-changed",t=>{console.log("Filter changed event received:",t.detail),this.currentCategory=t.detail.category,this.updateCategoryButtons(this.currentCategory),this.fetchListings(this.currentCategory,this.currentSort)}),document.addEventListener("sort-change",t=>{console.log("Sort change event received:",t.detail),this.currentSort=t.detail.sortBy,this.fetchListings(this.currentCategory,this.currentSort)})}async fetchListings(t="All",e=null){try{if(!this.productsContainer){console.error("Products container not found");return}this.productsContainer.innerHTML="";let r=[];e==="new"?r=await this.model.fetchAllListingsSortByDate(!1):e==="low"?r=await this.model.fetchAllListingsSortByPrice(!0):e==="high"?r=await this.model.fetchAllListingsSortByPrice(!1):t!=="All"?r=await this.model.fetchListingsByCategory(t):r=await this.model.fetchAllListings(),e&&t!=="All"&&(r=r.filter(i=>i.category===t)),r.forEach(i=>{this.renderListingCard(i)}),console.log(`Loaded ${r.length} listings (category: ${t}, sort: ${e})`)}catch(r){console.error("Controller failed to fetch listings:",r),this.productsContainer.innerHTML='<div class="no-results">Error loading listings.</div>'}}renderListingCard(t){if(!this.productsContainer){console.error("Cannot render card, products container not available");return}const e=this.model.formatListingForView(t),r=document.createElement("product-card");r.setAttribute("listing-id",e.listing_id||""),r.setAttribute("title",e.title||""),r.setAttribute("price",e.price||""),r.setAttribute("image-url",e.image_url||""),r.setAttribute("date",e.date_posted||""),r.classList.add("card"),this.productsContainer.appendChild(r)}updateCategoryButtons(t){this.categoryButtons.forEach(e=>{e.shadowRoot.querySelector("slot").assignedNodes().map(s=>s.textContent).join("").trim()===t?e.setAttribute("selected",""):e.removeAttribute("selected")}),console.log("Category selected:",t)}async showProductDetail(t){console.log("Showing product detail for listing ID:",t);try{const e=await this.model.getListingById(t);if(!e){console.error(`Listing with ID ${t} not found`);return}if(!this.overlay){console.error("Product overlay component not found");return}this.overlay.setAttribute("name",e.title||""),this.overlay.setAttribute("price",e.price||""),this.overlay.setAttribute("condition",e.condition||""),this.overlay.setAttribute("date",e.date_posted||""),this.overlay.setAttribute("description",e.description||"");let r="";e.images&&Array.isArray(e.images)&&e.images.length>0?r=JSON.stringify(e.images):e.thumbnail&&(r=e.thumbnail),this.overlay.setAttribute("images",r),this.overlay.show()}catch(e){console.error("Error showing product detail:",e)}}async renderSearchResults(t){if(!this.productsContainer){console.error("Products container not found");return}this.productsContainer.innerHTML="";try{const e=await this.model.searchListings(t);if(!e||e.length===0){this.productsContainer.innerHTML='<div class="no-results">No results found.</div>';return}e.forEach(r=>{this.renderListingCard(r)}),console.log(`Rendered ${e.length} search results for query: "${t}"`)}catch(e){this.productsContainer.innerHTML='<div class="no-results">Error searching listings.</div>',console.error("Error rendering search results:",e)}}notifyError(t){alert(t)}notifySuccess(t){alert(t)}}const C={NEW:"New",LIKE_NEW:"Like New",LIGHTLY_USED:"Lightly Used",USED:"Used"};class x{constructor(){this.model=new y}init(){document.addEventListener("listing-submit",this.handleListingSubmit.bind(this))}_generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}async convertImageToWebP(t){if(!t)throw new Error("No file provided");if(!["image/jpeg","image/png","image/heic","application/pdf","image/webp"].includes(t.type))throw this.notifyError("Only PNG, JPEG, HEIC, PDF, and WebP formats are allowed"),new Error("File type is not allowed");const r=t.type;let i;try{if(r==="image/heic"||t.name.endsWith(".HEIC")){i=await E({blob:t,toType:"image/webp",quality:.8});const s=new File([i],t.name.replace(/\.\w+$/,".webp"),{type:"image/webp"});i=await m(s,{maxSizeMB:.1,maxWidthOrHeight:800,fileType:"image/webp",useWebWorker:!0})}else i=await m(t,{maxSizeMB:.1,maxWidthOrHeight:800,fileType:"image/webp",useWebWorker:!0});return i}catch(s){throw console.error("Conversion failed:",s),s}}async _uploadFile(t,e,r,i=0){const s=`image_${i}_${Date.now()}.webp`,l=`${e}/${r}/${s}`,{data:c,error:g}=await o.storage.from("listimages").upload(l,t,{upsert:!1});if(g)throw console.error("Error uploading file:",g),g;const{data:d}=o.storage.from("listimages").getPublicUrl(l);if(console.log("Public URL:",d.publicUrl),d.error)throw console.error("Error getting public URL:",d.error),d.error;return d.publicUrl}async handleListingSubmit(t){console.log("Listing submit event received");const e=t.detail;if(console.log("Listing data:",e),!Object.values(p).includes(e.category)){this.notifyError("Invalid category selected.");return}if(!Object.values(C).includes(e.condition)){this.notifyError("Invalid condition selected.");return}try{const{data:{user:r},error:i}=await o.auth.getUser();if(!r){this.notifyError("You must be signed in to create a listing");return}const s=this._generateUUID();let l=null;const c=[];if(e.files&&e.files.length>0)try{for(let a=0;a<e.files.length;a++){const u=e.files[a],w=await this.convertImageToWebP(u),b=u.name.replace(/\.\w+$/,".webp"),L=new File([w],b,{type:"image/webp"}),f=await this._uploadFile(L,r.id,s,a);c.push(f),a===0&&(l=f)}delete e.files}catch(a){console.error("File upload error:",a),this.notifyError("File upload failed.");return}const g={...e,listing_id:s,user_id:r.id,thumbnail:l,images:c},{data:d,error:h}=await o.from("listings").insert([g]).select();if(h){this.notifyError(h.message||"Failed to create listing");return}this.notifySuccess("Listing created successfully"),t.target&&typeof t.target.resetForm=="function"&&t.target.resetForm(),window.location.replace("https://cse110-sp25-group15.github.io/cse110-sp25-group15/")}catch(r){console.error("Error handling listing submission:",r),this.notifyError("An unexpected error occurred")}}notifyError(t){alert(t)}notifySuccess(t){alert(t)}}document.addEventListener("DOMContentLoaded",async()=>{const n=new v;n.init(),new x().init();const e=document.querySelector(".logo");e&&e.addEventListener("click",()=>{window.location.href="/cse110-sp25-group15/"});const r=document.querySelector("hero-banner"),i=()=>{if(!r)return;r.getBoundingClientRect().bottom<=0&&r.remove()};window.addEventListener("scroll",i),document.querySelector("search-box")&&document.addEventListener("search-submit",async l=>{const c=l.detail.query;c&&await n.renderSearchResults(c)})});"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/cse110-sp25-group15/src/service-worker.js").then(function(n){console.log("Service Worker registered:",n.scope)}).catch(function(n){console.warn("Service Worker registration failed:",n)})});
